image: node:18

stages:
  - lint
  - build
  - test
  - security
  - package
  - deploy

variables:
  NODE_ENV: test
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_TLS_VERIFY: 1
  DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"

# Global cache configuration
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
  # Use pull-push policy to share cache between jobs
  policy: pull-push
  # Enable fallback to default key if specific key not found
  fallback_keys:
    - ${CI_DEFAULT_BRANCH}

# Lint Stage
lint:
  stage: lint
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
    policy: pull-push
  script:
    - npm ci
    - npm install --save-dev eslint prettier eslint-config-prettier eslint-plugin-prettier
    - npx eslint --ext .js . --fix
    - npx prettier --write .
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour

# Build Stage
build:
  stage: build
  dependencies:
    - lint
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
    policy: pull-push
  script:
    - npm ci --only=production --prefer-offline --no-audit
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour

# Test Stage
test:
  stage: test
  dependencies:
    - build
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
    policy: pull-push
  before_script:
    - npm ci --prefer-offline
  script:
    - npm test
  artifacts:
    when: always
    reports:
      junit: junit.xml
    paths:
      - coverage/
    expire_in: 1 week
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'

# Security Check
security:
  stage: security
  dependencies:
    - test
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
    policy: pull-push
  script:
    - npm ci --production
    - npm audit --production --audit-level=high
  only:
    - merge_requests
    - main
  allow_failure: true

# Package Stage
package:
  stage: package
  dependencies:
    - security
  image: docker:stable
  services:
    - docker:stable-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $DOCKER_IMAGE .
    - docker push $DOCKER_IMAGE
  only:
    - main
    - develop
  when: manual

# Deploy to Preview Environment
deploy_preview:
  stage: deploy
  image: alpine:latest
  variables:
    name: preview/$CI_COMMIT_REF_SLUG
    url: https://$CI_ENVIRONMENT_SLUG.$KUBE_INGRESS_BASE_DOMAIN
    on_stop: stop_preview
  environment:
    name: preview/$CI_COMMIT_REF_SLUG
    url: https://$CI_ENVIRONMENT_SLUG.$KUBE_INGRESS_BASE_DOMAIN
    on_stop: stop_preview
    auto_stop_in: 1 day
  script:
    - echo "Deploying to preview environment"
    - echo "Would deploy $DOCKER_IMAGE here"
  only:
    - merge_requests
  when: manual

stop_preview:
  stage: deploy
  variables:
    GIT_STRATEGY: none
  script:
    - echo "Removing preview environment"
  when: manual
  environment:
    name: preview/$CI_COMMIT_REF_SLUG
    action: stop

# Deploy to Staging Environment
deploy_staging:
  stage: deploy
  dependencies:
    - package
  image: alpine:latest
  environment:
    name: staging
    url: https://staging.$KUBE_INGRESS_BASE_DOMAIN
  script:
    - echo "Deploying to staging environment"
    - echo "Would deploy $DOCKER_IMAGE here"
  only:
    - main
  when: manual
  needs: ["package"]

# Deploy to Production Environment
deploy_production:
  stage: deploy
  dependencies:
    - deploy_staging
  image: alpine:latest
  environment:
    name: production
    url: https://$CI_DOMAIN
  script:
    - echo "Deploying to production environment"
    - echo "Would deploy $DOCKER_IMAGE here"
  only:
    - main
  when: manual
  needs: ["deploy_staging"]

# Pipeline workflow rules
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG
  